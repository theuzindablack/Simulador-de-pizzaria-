
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pizzaria Tycoon - Empilhamento Real</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Poppins', sans-serif; touch-action: none; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; z-index: 10; display: flex; flex-direction: column; gap: 8px; }
        .stat { background: rgba(20, 20, 40, 0.9); padding: 10px 20px; border-radius: 12px; border-left: 6px solid #f1c40f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        #joy-base { position: absolute; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; z-index: 100; border: 2px solid rgba(255,255,255,0.2); }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .progress-container { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 180px; height: 14px; background: rgba(0,0,0,0.6); border-radius: 20px; display: none; overflow: hidden; border: 2px solid #fff; z-index: 100; }
        #progressBar { height: 100%; width: 0%; background: linear-gradient(90deg, #2ecc71, #f1c40f); }
    </style>
</head>
<body>

<div id="ui">
    <div class="stat"><span>üí∞</span> <span id="moneyText">0</span></div>
    <div class="stat"><span>üçï</span> <span id="handText">0</span> / 10</div>
</div>

<div class="progress-container" id="p-cont"><div id="progressBar"></div></div>
<div id="joy-base"><div id="joy-stick"></div></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let money = 0; let playerHand = []; let progress = 0; let walkCycle = 0;
let player = { x: 400, y: 350, vx: 0, vy: 0 };
let camPos = { x: 450, y: 350 };
let zoom = 0.65;

let customer = { x: 700, y: -100, order: 1, state: 'ENTERING', targetY: 350, hasPizza: false };

function spawnCustomer() {
    customer.x = 750; customer.y = -100;
    customer.order = Math.floor(Math.random() * 3) + 1;
    customer.state = 'ENTERING'; customer.hasPizza = false;
}

function toIso(x, y) { return { x: (x - y) * zoom, y: (x + y) * 0.5 * zoom }; }

const obstacles = [
    { x: 150, y: 150, w: 500, h: 20, z: 80, color: '#34495e', side: '#2c3e50', type: 'wall' }, 
    { x: 150, y: 150, w: 20, h: 450, z: 80, color: '#34495e', side: '#2c3e50', type: 'wall' }, 
    { x: 220, y: 180, w: 100, h: 60, z: 35, color: '#f5f6fa', side: '#dcdde1', label: 'MASSA', type: 'massa', icon: 'üçû' },
    { x: 400, y: 180, w: 120, h: 60, z: 35, color: '#ecf0f1', side: '#bdc3c7', label: 'RECHEAR', type: 'recheio', icon: 'üçÖ' },
    { x: 200, y: 450, w: 100, h: 100, z: 50, color: '#e67e22', side: '#d35400', label: 'FORNO', type: 'forno', icon: 'üî•' },
    { x: 400, y: 450, w: 120, h: 60, z: 35, color: '#d35400', side: '#a04000', label: 'EMBALAR', type: 'embalar', icon: 'üì¶' },
    { x: 650, y: 250, w: 40, h: 200, z: 40, color: '#8d6e63', side: '#5d4037', label: 'ENTREGA', type: 'delivery', icon: '‚úÖ' }
];

function drawIsoBox(x, y, w, h, z, color, sideColor, isZone = false) {
    let p1 = toIso(x, y); let p2 = toIso(x + w, y);
    let p3 = toIso(x + w, y + h); let p4 = toIso(x, y + h);
    let hz = z * zoom;
    if (isZone) {
        ctx.fillStyle = "rgba(46, 204, 113, 0.4)";
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.fill();
        return;
    }
    ctx.fillStyle = sideColor;
    ctx.beginPath(); ctx.moveTo(p2.x, p2.y); ctx.lineTo(p2.x, p2.y - hz); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p3.x, p3.y); ctx.fill();
    ctx.filter = "brightness(80%)";
    ctx.beginPath(); ctx.moveTo(p3.x, p3.y); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p4.x, p4.y - hz); ctx.lineTo(p4.x, p4.y); ctx.fill();
    ctx.filter = "none";
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y - hz); ctx.lineTo(p2.x, p2.y - hz); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p4.x, p4.y - hz); ctx.fill();
}

function update() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let nx = player.x + player.vx, ny = player.y + player.vy;
    let canX = true, canY = true;
    obstacles.forEach(o => {
        if (nx + 15 > o.x && nx - 15 < o.x + o.w && player.y + 15 > o.y && player.y - 15 < o.y + o.h) canX = false;
        if (player.x + 15 > o.x && player.x - 15 < o.x + o.w && ny + 15 > o.y && ny - 15 < o.y + o.h) canY = false;
    });
    if(canX) player.x = nx; if(canY) player.y = ny;
    camPos.x += (player.x - camPos.x) * 0.1; camPos.y += (player.y - camPos.y) * 0.1;

    if(customer.state === 'ENTERING') { customer.y += 3; if(customer.y >= customer.targetY) customer.state = 'WAITING'; }
    else if(customer.state === 'LEAVING') { customer.y += 4; if(customer.y > 1000) { customer.state = 'HIDDEN'; setTimeout(spawnCustomer, 2000); } }

    let inZone = false;
    obstacles.forEach(s => {
        if(!s.type || s.type === 'wall') return;
        let tx = s.x, ty = s.y, tw = s.w, th = s.h;
        if(s.type === 'delivery') { tx -= 45; tw = 45; }
        else if(s.type === 'forno' || s.type === 'embalar') { ty -= 45; th = 45; }
        else { ty += s.h; th = 45; }

        if(player.x > tx - 10 && player.x < tx + tw + 10 && player.y > ty - 10 && player.y < ty + th + 10) {
            inZone = true; progress += 3.5;
            document.getElementById('p-cont').style.display = 'block';
            document.getElementById('progressBar').style.width = progress + '%';
            if(progress >= 100) {
                if(s.type === 'massa' && playerHand.length < 10) playerHand.push('massa');
                if(s.type === 'recheio' && playerHand.includes('massa')) playerHand[playerHand.indexOf('massa')] = 'recheada';
                if(s.type === 'forno' && playerHand.includes('recheada')) playerHand[playerHand.indexOf('recheada')] = 'assada';
                if(s.type === 'embalar' && playerHand.includes('assada')) playerHand[playerHand.indexOf('assada')] = 'caixa';
                if(s.type === 'delivery' && playerHand.includes('caixa') && customer.state === 'WAITING') { 
                    playerHand.splice(playerHand.lastIndexOf('caixa'), 1);
                    customer.order--; money += 4200;
                    if(customer.order <= 0) { customer.state = 'LEAVING'; customer.hasPizza = true; }
                }
                progress = 0;
            }
        }
    });
    if(!inZone) { progress = 0; document.getElementById('p-cont').style.display = 'none'; }
    document.getElementById('moneyText').innerText = money.toLocaleString();
    document.getElementById('handText').innerText = playerHand.length;
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    let cI = toIso(camPos.x, camPos.y);
    ctx.translate(canvas.width/2 - cI.x, canvas.height/2 - cI.y);

    drawIsoBox(720, -200, 300, 1400, 2, "#34495e", "#2c3e50"); 
    drawIsoBox(690, -200, 30, 1400, 5, "#7f8c8d", "#95a5a6"); 
    drawIsoBox(150, 150, 540, 450, 5, "#2c3e50", "#1a252f");

    obstacles.forEach(s => {
        if(s.type === 'delivery') drawIsoBox(s.x - 40, s.y, 40, s.h, 0, "", "", true);
        else if(s.type === 'forno' || s.type === 'embalar') drawIsoBox(s.x, s.y - 40, s.w, 40, 0, "", "", true);
        else if(s.type !== 'wall') drawIsoBox(s.x, s.y + s.h, s.w, 40, 0, "", "", true);
        drawIsoBox(s.x, s.y, s.w, s.h, s.z, s.color, s.side);
        if(s.label) {
            let p = toIso(s.x + s.w/2, s.y + s.h/2);
            ctx.fillStyle = "white"; ctx.font = `bold ${14*zoom}px Poppins`; ctx.textAlign = "center";
            ctx.fillText(s.icon + " " + s.label, p.x, p.y - (s.z*zoom) - 10);
        }
    });

    if(customer.state !== 'HIDDEN') {
        let custI = toIso(customer.x, customer.y);
        let cBob = Math.sin(Date.now()/150) * 3;
        drawIsoBox(customer.x-12, customer.y-12, 24, 24, 35 + cBob, "#e74c3c", "#c0392b");
        ctx.fillStyle = "#ffdbac"; ctx.beginPath(); ctx.arc(custI.x, custI.y - (45*zoom) + (cBob*zoom), 10*zoom, 0, Math.PI*2); ctx.fill();
        if(customer.state === 'WAITING') {
            let bx = custI.x + (50*zoom), by = custI.y - (80*zoom);
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.roundRect(bx - (30*zoom), by - (25*zoom), 60*zoom, 35*zoom, 8); ctx.fill();
            ctx.fillStyle = "#333"; ctx.font = `bold ${16*zoom}px Arial`; ctx.fillText("üì¶ x" + customer.order, bx + (2*zoom), by - (2*zoom));
        }
        if(customer.hasPizza) {
            drawIsoBox(customer.x + 5, customer.y - 15, 30, 30, 8, "#d2b48c", "#8b4513");
        }
    }

    let pI = toIso(player.x, player.y);
    walkCycle += (player.vx !== 0 || player.vy !== 0) ? 0.25 : 0;
    let bob = Math.sin(walkCycle) * 4;
    
    // CORPO DO JOGADOR
    drawIsoBox(player.x-10, player.y-10, 20, 20, 35 + bob, "#3498db", "#2980b9");
    ctx.fillStyle = "#ffdbac"; ctx.beginPath(); ctx.arc(pI.x, pI.y - (45*zoom) + (bob*zoom), 10*zoom, 0, Math.PI*2); ctx.fill();
    drawIsoBox(player.x-8, player.y-8, 16, 16, 60 + bob, "white", "#ddd");

    // --- L√ìGICA DE EMPILHAMENTO VERTICAL ---
    let currentStackHeight = 65; // Come√ßa na altura das m√£os
    playerHand.forEach((h, i) => {
        let px = player.x + 15; // Posi√ß√£o fixa √† frente do jogador
        let py = player.y - 15;
        let visualHeight = (currentStackHeight + bob) * zoom;
        let isoStack = toIso(px, py);

        if (h === 'caixa') {
            // Desenha a caixa na pilha
            drawIsoBox(px, py, 30, 30, currentStackHeight + bob + 8, "#d2b48c", "#8b4513");
            currentStackHeight += 10; // Sobe a pilha para a pr√≥xima caixa
        } else {
            // Desenha a pizza aberta na pilha
            let drawY = isoStack.y - visualHeight;
            ctx.fillStyle = h === 'assada' ? "#d35400" : "#f1c40f"; 
            ctx.beginPath(); ctx.ellipse(isoStack.x, drawY, 18*zoom, 9*zoom, 0, 0, Math.PI*2); ctx.fill();
            if (h === 'recheada' || h === 'assada') {
                ctx.fillStyle = h === 'recheada' ? "#e74c3c" : "#f39c12";
                ctx.beginPath(); ctx.ellipse(isoStack.x, drawY, 13*zoom, 6*zoom, 0, 0, Math.PI*2); ctx.fill();
            }
            currentStackHeight += 5; // Sobe menos para pizzas abertas
        }
    });

    ctx.restore();
    requestAnimationFrame(draw);
}

// Joystick e Eventos
let joyActive = false; let joyOrigin = { x: 0, y: 0 };
const handleMove = (x, y) => {
    let dx = x - joyOrigin.x, dy = y - joyOrigin.y;
    let d = Math.sqrt(dx*dx+dy*dy), mx = dx/(d||1), my = dy/(d||1);
    let speed = Math.min(d, 50) / 7;
    player.vx = mx * speed; player.vy = my * speed;
    document.getElementById('joy-stick').style.transform = `translate(${mx*25}px, ${my*25}px)`;
};
window.addEventListener('mousedown', e => { joyActive = true; joyOrigin = { x: e.clientX, y: e.clientY }; document.getElementById('joy-base').style.display = 'block'; document.getElementById('joy-base').style.left = (joyOrigin.x-50)+'px'; document.getElementById('joy-base').style.top = (joyOrigin.y-50)+'px'; });
window.addEventListener('mousemove', e => { if(joyActive) handleMove(e.clientX, e.clientY); });
window.addEventListener('mouseup', () => { joyActive = false; document.getElementById('joy-base').style.display='none'; player.vx=0; player.vy=0; });
window.addEventListener('touchstart', e => { let t = e.touches[0]; joyActive = true; joyOrigin = { x: t.clientX, y: t.clientY }; const jb = document.getElementById('joy-base'); jb.style.display = 'block'; jb.style.left = (joyOrigin.x-50)+'px'; jb.style.top = (joyOrigin.y-50)+'px'; });
window.addEventListener('touchmove', e => { if(joyActive) handleMove(e.touches[0].clientX, e.touches[0].clientY); });
window.addEventListener('touchend', () => { joyActive = false; document.getElementById('joy-base').style.display='none'; player.vx=0; player.vy=0; });

setInterval(update, 1000/60); spawnCustomer(); draw();
</script>
</body>
</html>
