<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pizzaria Tycoon - Upgrade Workers</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Poppins', sans-serif; touch-action: none; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; z-index: 10; display: flex; flex-direction: column; gap: 8px; }
        .stat { background: rgba(20, 20, 40, 0.9); padding: 10px 20px; border-radius: 12px; border-left: 6px solid #f1c40f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        #joy-base { position: absolute; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; z-index: 100; border: 2px solid rgba(255,255,255,0.2); }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .progress-container { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 180px; height: 14px; background: rgba(0,0,0,0.6); border-radius: 20px; display: none; overflow: hidden; border: 2px solid #fff; z-index: 100; }
        #progressBar { height: 100%; width: 0%; background: linear-gradient(90deg, #2ecc71, #f1c40f); }
    </style>
</head>
<body>

<div id="ui">
    <div class="stat"><span>üí∞</span> <span id="moneyText">0</span></div>
    <div class="stat"><span>üçï</span> <span id="handText">0</span> / 20</div>
</div>

<div class="progress-container" id="p-cont"><div id="progressBar"></div></div>
<div id="joy-base"><div id="joy-stick"></div></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let money = 20000; // Come√ßa com dinheiro para testar a fileira
let playerHand = []; 
let progress = 0; 
let walkCycle = 0;
let player = { x: 400, y: 350, vx: 0, vy: 0, radius: 12 };
let camPos = { x: 450, y: 350 };
let zoom = 0.55;

let customers = [];
const MAX_CUSTOMERS = 5;
const LINE_X = 750;
const LINE_START_Y = 350;
const LINE_SPACING = 70;

function generateOrder() {
    let r = Math.random();
    if (r > 0.96) return Math.floor(Math.random() * 2) + 9; 
    if (r > 0.88) return Math.floor(Math.random() * 3) + 5; 
    return Math.floor(Math.random() * 3) + 1;
}

function spawnCustomer() {
    if (customers.length < MAX_CUSTOMERS) {
        customers.push({
            x: LINE_X, y: -100,
            order: generateOrder(),
            state: 'ENTERING',
            hasPizza: false,
            color: `hsl(${Math.random() * 360}, 60%, 50%)`
        });
    }
}

let workers = [];
const WORKER_TYPES = {
    MASSA: { color: '#f1c40f', target: {x: 270, y: 260}, price: 5000, label: "PREPARO" },
    RECHEIO: { color: '#e74c3c', target: {x: 460, y: 260}, price: 8000, label: "RECHEIO" },
    FORNO: { color: '#e67e22', target: {x: 320, y: 450}, price: 12000, label: "COZINHA" },
    EMBALAR: { color: '#9b59b6', target: {x: 540, y: 450}, price: 15000, label: "EMBALO" }
};

// --- NOVA FILEIRA DE COMPRA ---
const hireButtons = [
    { x: 750, y: 850, type: 'MASSA' },
    { x: 830, y: 850, type: 'RECHEIO' },
    { x: 910, y: 850, type: 'FORNO' },
    { x: 990, y: 850, type: 'EMBALAR' }
];

class Worker {
    constructor(type) {
        this.type = type;
        this.x = 900; this.y = 900;
        this.target = WORKER_TYPES[type].target;
        this.color = WORKER_TYPES[type].color;
        this.reached = false;
        this.progress = 0;
        this.bob = 0;
    }
    update() {
        if (!this.reached) {
            let dx = this.target.x - this.x;
            let dy = this.target.y - this.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 5) this.reached = true;
            else { this.x += dx/dist * 2.5; this.y += dy/dist * 2.5; this.bob = Math.sin(Date.now()/150) * 5; }
        } else {
            this.progress += 0.3;
            if (this.progress >= 100) {
                this.progress = 0;
                if (this.type === 'MASSA' && playerHand.length < 20) playerHand.push('massa');
                if (this.type === 'RECHEIO' && playerHand.includes('massa')) playerHand[playerHand.indexOf('massa')] = 'recheada';
                if (this.type === 'FORNO' && playerHand.includes('recheada')) playerHand[playerHand.indexOf('recheada')] = 'assada';
                if (this.type === 'EMBALAR' && playerHand.includes('assada')) playerHand[playerHand.indexOf('assada')] = 'caixa';
            }
        }
    }
}

function toIso(x, y) { return { x: (x - y) * zoom, y: (x + y) * 0.5 * zoom }; }

const obstacles = [
    { x: 150, y: 150, w: 540, h: 20, z: 80, color: '#34495e', side: '#2c3e50', type: 'wall' }, 
    { x: 150, y: 150, w: 20, h: 450, z: 80, color: '#34495e', side: '#2c3e50', type: 'wall' }, 
    { x: 220, y: 180, w: 100, h: 60, z: 35, color: '#f5f6fa', side: '#dcdde1', label: 'MASSA', type: 'massa', icon: 'üçû' },
    { x: 400, y: 180, w: 120, h: 60, z: 35, color: '#ecf0f1', side: '#bdc3c7', label: 'RECHEAR', type: 'recheio', icon: 'üçÖ' },
    { x: 200, y: 450, w: 100, h: 100, z: 50, color: '#e67e22', side: '#d35400', label: 'FORNO', type: 'forno', icon: 'üî•' },
    { x: 400, y: 450, w: 120, h: 60, z: 35, color: '#d35400', side: '#a04000', label: 'EMBALAR', type: 'embalar', icon: 'üì¶' },
    { x: 650, y: 250, w: 40, h: 200, z: 40, color: '#8d6e63', side: '#5d4037', label: 'ENTREGA', type: 'delivery', icon: '‚úÖ' }
];

function checkCollision(nx, ny) {
    for (let o of obstacles) {
        if (nx + player.radius > o.x && nx - player.radius < o.x + o.w && ny + player.radius > o.y && ny - player.radius < o.y + o.h) return true;
    }
    return false;
}

function update() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    
    let nextX = player.x + player.vx;
    let nextY = player.y + player.vy;
    if (!checkCollision(nextX, player.y)) player.x = nextX;
    if (!checkCollision(player.x, nextY)) player.y = nextY;

    camPos.x += (player.x - camPos.x) * 0.1; camPos.y += (player.y - camPos.y) * 0.1;
    workers.forEach(w => w.update());

    customers.forEach((c, i) => {
        let targetY = LINE_START_Y - (i * LINE_SPACING);
        if(c.state === 'ENTERING' || c.state === 'WAITING') {
            if(c.y < targetY) c.y += 3;
            if(c.y >= targetY) c.state = 'WAITING';
        } else if(c.state === 'LEAVING') {
            c.y += 4;
            if(c.y > 1000) { customers.splice(i, 1); setTimeout(spawnCustomer, 2000); }
        }
    });

    let inZone = false;
    obstacles.forEach(s => {
        if(!s.type || s.type === 'wall') return;
        let range = 60;
        let dist = Math.sqrt(Math.pow(player.x - (s.x + s.w/2), 2) + Math.pow(player.y - (s.y + s.h/2), 2));
        
        if(dist < range + 20) {
            inZone = true; progress += 4;
            document.getElementById('p-cont').style.display = 'block';
            document.getElementById('progressBar').style.width = progress + '%';
            if(progress >= 100) {
                if(s.type === 'massa' && playerHand.length < 20) playerHand.push('massa');
                if(s.type === 'recheio' && playerHand.includes('massa')) playerHand[playerHand.indexOf('massa')] = 'recheada';
                if(s.type === 'forno' && playerHand.includes('recheada')) playerHand[playerHand.indexOf('recheada')] = 'assada';
                if(s.type === 'embalar' && playerHand.includes('assada')) playerHand[playerHand.indexOf('assada')] = 'caixa';
                if(s.type === 'delivery' && playerHand.includes('caixa')) { 
                    let firstCust = customers[0];
                    if(firstCust && firstCust.state === 'WAITING') {
                        playerHand.splice(playerHand.lastIndexOf('caixa'), 1);
                        firstCust.order--; money += 2000;
                        if(firstCust.order <= 0) { firstCust.state = 'LEAVING'; firstCust.hasPizza = true; }
                    }
                }
                progress = 0;
            }
        }
    });

    // Colis√£o com bot√µes de compra
    hireButtons.forEach(b => {
        let dist = Math.sqrt(Math.pow(player.x - b.x, 2) + Math.pow(player.y - b.y, 2));
        if (dist < 35) {
            let data = WORKER_TYPES[b.type];
            if (money >= data.price) { 
                money -= data.price; 
                workers.push(new Worker(b.type)); 
                player.x -= 80; // Repulsa para n√£o comprar v√°rios sem querer
            }
        }
    });

    if(!inZone) { progress = 0; document.getElementById('p-cont').style.display = 'none'; }
    document.getElementById('moneyText').innerText = money.toLocaleString();
    document.getElementById('handText').innerText = playerHand.length;
}

function drawIsoBox(x, y, w, h, z, color, sideColor, isZone = false) {
    let p1 = toIso(x, y); let p2 = toIso(x + w, y);
    let p3 = toIso(x + w, y + h); let p4 = toIso(x, y + h);
    let hz = z * zoom;
    if (isZone) {
        ctx.fillStyle = color || "rgba(46, 204, 113, 0.4)";
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.fill();
        return;
    }
    ctx.fillStyle = sideColor;
    ctx.beginPath(); ctx.moveTo(p2.x, p2.y); ctx.lineTo(p2.x, p2.y - hz); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p3.x, p3.y); ctx.fill();
    ctx.filter = "brightness(80%)";
    ctx.beginPath(); ctx.moveTo(p3.x, p3.y); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p4.x, p4.y - hz); ctx.lineTo(p4.x, p4.y); ctx.fill();
    ctx.filter = "none";
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y - hz); ctx.lineTo(p2.x, p2.y - hz); ctx.lineTo(p3.x, p3.y - hz); ctx.lineTo(p4.x, p4.y - hz); ctx.fill();
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    let cI = toIso(camPos.x, camPos.y);
    ctx.translate(canvas.width/2 - cI.x, canvas.height/2 - cI.y);

    // Ch√£o e Pr√©dio
    drawIsoBox(720, -200, 300, 1400, 2, "#34495e", "#2c3e50"); 
    drawIsoBox(150, 150, 540, 450, 5, "#2c3e50", "#1a252f");
    drawIsoBox(720, 780, 400, 180, 5, "#4a3c31", "#2d241e"); // √Årea dos bot√µes

    // Bot√µes de Compra Organizados
    hireButtons.forEach(b => {
        let info = WORKER_TYPES[b.type];
        drawIsoBox(b.x-30, b.y-30, 60, 60, 2, info.color, info.color, true);
        let p = toIso(b.x, b.y);
        ctx.fillStyle = "white"; ctx.textAlign = "center";
        ctx.font = `bold ${10*zoom}px Poppins`;
        ctx.fillText(info.label, p.x, p.y - 15*zoom); // Nome em cima
        ctx.font = `bold ${13*zoom}px Poppins`;
        ctx.fillText("$" + info.price, p.x, p.y + 5*zoom); // Pre√ßo embaixo
    });

    obstacles.forEach(s => {
        drawIsoBox(s.x, s.y, s.w, s.h, s.z, s.color, s.side);
        if(s.label) {
            let p = toIso(s.x + s.w/2, s.y + s.h/2);
            ctx.fillStyle = "white"; ctx.font = `bold ${14*zoom}px Poppins`; ctx.textAlign = "center";
            ctx.fillText(s.icon + " " + s.label, p.x, p.y - (s.z*zoom) - 10);
        }
    });

    customers.forEach((cust, i) => {
        let custI = toIso(cust.x, cust.y);
        let cBob = Math.sin(Date.now()/150 + i) * 3;
        drawIsoBox(cust.x-15, cust.y-15, 30, 30, 40 + cBob, cust.color, "#333");
        ctx.fillStyle = "#ffdbac"; ctx.beginPath(); ctx.arc(custI.x, custI.y - (50*zoom) + (cBob*zoom), 12*zoom, 0, Math.PI*2); ctx.fill();
        if(i === 0 && cust.state === 'WAITING') {
            let bx = custI.x + (50*zoom), by = custI.y - (80*zoom);
            ctx.fillStyle = "white"; ctx.beginPath(); ctx.roundRect(bx - (40*zoom), by - (25*zoom), 80*zoom, 40*zoom, 8); ctx.fill();
            ctx.fillStyle = "#333"; ctx.font = `bold ${20*zoom}px Arial`; ctx.textAlign = "center";
            ctx.fillText("üì¶ x" + cust.order, bx, by + (5*zoom));
        }
    });

    workers.forEach(w => {
        let wI = toIso(w.x, w.y);
        drawIsoBox(w.x-12, w.y-12, 24, 24, 35 + w.bob, w.color, "#333");
        ctx.fillStyle = "#ffdbac"; ctx.beginPath(); ctx.arc(wI.x, wI.y - (45*zoom) + (w.bob*zoom), 10*zoom, 0, Math.PI*2); ctx.fill();
    });

    let pI = toIso(player.x, player.y);
    walkCycle += (player.vx !== 0 || player.vy !== 0) ? 0.25 : 0;
    let bob = Math.sin(walkCycle) * 4;
    drawIsoBox(player.x-10, player.y-10, 20, 20, 35 + bob, "#3498db", "#2980b9");
    ctx.fillStyle = "#ffdbac"; ctx.beginPath(); ctx.arc(pI.x, pI.y - (45*zoom) + (bob*zoom), 10*zoom, 0, Math.PI*2); ctx.fill();

    let currentStackHeight = 65;
    playerHand.forEach((h, i) => {
        let px = player.x + 15, py = player.y - 15;
        let isoStack = toIso(px, py);
        let drawY = isoStack.y - (currentStackHeight + bob) * zoom;
        if (h === 'caixa') {
            drawIsoBox(px, py, 32, 32, currentStackHeight + bob + 8, "#d2b48c", "#8b4513");
            currentStackHeight += 10;
        } else {
            ctx.fillStyle = h === 'assada' ? "#d35400" : "#f1c40f"; 
            ctx.beginPath(); ctx.ellipse(isoStack.x, drawY, 18*zoom, 9*zoom, 0, 0, Math.PI*2); ctx.fill();
            currentStackHeight += 6;
        }
    });

    ctx.restore();
    requestAnimationFrame(draw);
}

// Input Handlers
let joyActive = false; let joyOrigin = { x: 0, y: 0 };
const handleMove = (x, y) => {
    let dx = x - joyOrigin.x, dy = y - joyOrigin.y;
    let d = Math.sqrt(dx*dx+dy*dy), mx = dx/(d||1), my = dy/(d||1);
    let speed = Math.min(d, 50) / 7;
    player.vx = mx * speed; player.vy = my * speed;
    document.getElementById('joy-stick').style.transform = `translate(${mx*25}px, ${my*25}px)`;
};
window.addEventListener('mousedown', e => { joyActive = true; joyOrigin = { x: e.clientX, y: e.clientY }; document.getElementById('joy-base').style.display = 'block'; document.getElementById('joy-base').style.left = (joyOrigin.x-50)+'px'; document.getElementById('joy-base').style.top = (joyOrigin.y-50)+'px'; });
window.addEventListener('mousemove', e => { if(joyActive) handleMove(e.clientX, e.clientY); });
window.addEventListener('mouseup', () => { joyActive = false; document.getElementById('joy-base').style.display='none'; player.vx=0; player.vy=0; });
window.addEventListener('touchstart', e => { joyActive = true; joyOrigin = { x: e.touches[0].clientX, y: e.touches[0].clientY }; document.getElementById('joy-base').style.display = 'block'; document.getElementById('joy-base').style.left = (joyOrigin.x-50)+'px'; document.getElementById('joy-base').style.top = (joyOrigin.y-50)+'px'; });
window.addEventListener('touchmove', e => { if(joyActive) handleMove(e.touches[0].clientX, e.touches[0].clientY); });
window.addEventListener('touchend', () => { joyActive = false; document.getElementById('joy-base').style.display='none'; player.vx=0; player.vy=0; });

for(let i=0; i<3; i++) setTimeout(spawnCustomer, i * 1500);
setInterval(update, 1000/60); draw();
</script>
</body>
</html>
